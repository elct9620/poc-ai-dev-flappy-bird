# Flappy Bird 遊戲設計文件

## 1. 遊戲概述

Flappy Bird 是一款簡單的橫向捲軸遊戲，玩家透過點擊或按鍵控制一隻小鳥飛行，在不斷移動的障礙物（管道）之間穿梭。遊戲的目標是讓小鳥持續飛行並通過越多管道越好，每通過一對管道就會獲得 1 分。

遊戲採用物理模擬，小鳥會受到重力影響持續下墜，玩家必須適時點擊讓小鳥向上飛行。如果小鳥撞到管道、地面或掉出螢幕範圍，遊戲就會結束。

---

## 2. 遊戲玩法

### 如何遊玩

- 玩家點擊滑鼠或按下空白鍵，小鳥就會向上「拍翅」飛行
- 小鳥會持續受到重力影響往下墜落，玩家必須反覆點擊維持飛行高度
- 管道會從螢幕右側持續出現，並向左側移動
- 玩家需要操控小鳥穿過管道之間的縫隙
- 每成功通過一對管道，分數會增加 1 分

### 遊戲目標

在小鳥墜毀前盡可能獲得更高的分數。遊戲沒有結束條件，玩家可以持續挑戰更高分數。

### 控制方式

- **滑鼠左鍵點擊**：讓小鳥向上拍翅
- **空白鍵（Space）**：讓小鳥向上拍翅

---

## 3. 遊戲規則

### 得分機制

- 小鳥成功通過一對管道（上下兩根管道）時，分數增加 **1 分**
- 每對管道只會計分一次，避免重複計分
- 分數會即時顯示在螢幕上方中央位置
- 成功通過管道時會播放得分音效（point.ogg）提供聲音回饋

**得分判定邏輯**：
- 系統透過邊緣比較演算法偵測小鳥是否通過管道
- 當小鳥的右側邊緣超過管道的右側邊緣時，視為成功通過
- 所有尺寸都會根據響應式縮放比例調整，確保在不同螢幕尺寸下判定一致
- 每對管道的「已通過」旗標確保只觸發一次計分

### 失敗條件

當以下任一情況發生時，遊戲結束：

1. **撞到管道**：小鳥與管道發生碰撞（上方或下方的管道）
2. **撞到地面**：小鳥落地觸碰到螢幕底部的地面
3. **掉出螢幕**：小鳥飛出螢幕頂部範圍

**遊戲結束流程**：
- 當發生碰撞時，小鳥會被標記為死亡狀態
- 所有障礙物、背景和地面停止捲動
- 小鳥失去控制，持續受重力影響下墜
- 小鳥最終落地後，遊戲完全停止
- 顯示最終分數（未來功能）

### 物理規則

#### 重力系統
- 小鳥會持續受到向下的重力加速度影響（**0.08 像素/幀²**）
- 小鳥的下墜速度有上限（**終端速度：1 像素/幀**），避免墜落過快

#### 拍翅機制
- 玩家點擊或按鍵時，小鳥會獲得向上的初速度（**-3 像素/幀**）
- 每次拍翅都會重置小鳥的垂直速度，不會累積

#### 旋轉角度
- 小鳥的旋轉角度會根據垂直速度自動調整：
  - 向上飛行時，小鳥會向上傾斜（最大 **-25 度**）
  - 下墜時，小鳥會向下傾斜（最大 **+90 度**）
- 旋轉提供視覺回饋，讓玩家更容易判斷小鳥的移動狀態

#### 管道移動
- 管道以固定速度（**2 像素/幀**）從右向左水平移動
- 管道之間的距離固定為 **200 像素**
- 管道的縫隙大小為 **140-160 像素**
- 縫隙的垂直位置會隨機變化（範圍 **120-280 像素**），提供不同難度

---

## 4. 遊戲元素

### 實體（Entities）

遊戲中的所有物件都以「實體」的形式存在，每個實體代表一個獨立的遊戲物件。

#### 玩家角色 - 小鳥（Bird）

- **描述**：玩家操控的角色，會受到重力影響並可透過拍翅向上飛行
- **特性**：
  - 有位置、速度、旋轉角度等物理屬性
  - 有存活狀態（活著 / 死亡）
  - 視覺上有三幀翅膀動畫（下拍、中間、上拍），循環播放形成拍翅效果
  - 死亡時動畫會停止
- **行為**：
  - 持續受重力影響下墜
  - 玩家點擊時會向上拍翅
  - 根據速度自動調整旋轉角度

#### 障礙物 - 管道（Pipe）

- **描述**：從右側出現的障礙物，成對出現（上下兩根）中間有縫隙
- **特性**：
  - 有位置、高度、縫隙位置等屬性
  - 分為上方管道和下方管道（透過垂直翻轉實現）
  - 有「已通過」標記，用於計分
- **行為**：
  - 以固定速度從右向左移動
  - 移出螢幕後會被移除
  - 當小鳥通過時會標記為「已通過」並增加分數

#### 場景元素 - 背景（Background）

- **描述**：提供遊戲視覺背景的靜態圖層
- **特性**：
  - 使用平鋪材質（Tiling Sprite）自動填滿螢幕
  - 位於所有其他元素的最底層
- **行為**：無互動，純視覺元素

#### 場景元素 - 地面（Ground）

- **描述**：位於螢幕底部的地面圖層
- **特性**：
  - 使用平鋪材質橫向填滿螢幕底部
  - 位於較高的視覺層級（覆蓋超出範圍的管道）
- **行為**：無互動，但小鳥碰到地面會失敗

#### 介面元素 - 分數（Score）

- **描述**：顯示當前分數的 UI 元素
- **特性**：
  - 使用數字精靈圖片（0-9）拼接顯示
  - 可設定位置、間距、對齊方式（左/中/右）
  - 支援響應式縮放，適應不同螢幕尺寸
- **行為**：
  - 分數增加時會即時更新顯示
  - 可以重置為 0（開始新遊戲時）

---

### 系統運作（Systems）

系統負責處理遊戲中的各種邏輯和互動，每個系統專注於特定的功能。

#### 輸入系統（Input System）

- **功能**：接收玩家的滑鼠和鍵盤輸入，轉換為遊戲指令
- **處理事件**：
  - 滑鼠點擊 → 觸發小鳥拍翅
  - 空白鍵按下 → 觸發小鳥拍翅
- **運作方式**：監聽瀏覽器的輸入事件，發送拍翅指令給物理系統

#### 物理系統（Physics System）

- **功能**：管理小鳥的物理行為，包括重力、拍翅、位置更新和旋轉
- **處理事件**：
  - 每幀更新 → 應用重力、更新位置、調整旋轉角度
  - 拍翅指令 → 施加向上的速度
- **運作方式**：
  - 每幀對小鳥施加向下的重力加速度
  - 根據小鳥的速度更新位置
  - 根據速度方向調整小鳥的旋轉角度
  - 限制最大下墜速度（終端速度）

#### 計分系統（Score System）

- **功能**：管理分數的創建、更新、重置和移除
- **處理事件**：
  - 創建分數實體 → 初始化分數顯示
  - 增加分數 → 分數值加 1
  - 重置分數 → 分數值歸零
  - 移除分數 → 清除分數顯示
- **運作方式**：維護分數實體的狀態，並通知視覺層更新顯示

#### 障礙物系統（Pipe System）

- **功能**：管理管道的生成、移動和移除
- **處理事件**：
  - 創建管道 → 生成一對管道（上下），隨機設定縫隙位置
  - 每幀更新 → 所有管道向左移動
  - 通過檢測 → 當小鳥飛過管道時標記為「已通過」並增加分數
  - 移除管道 → 當管道移出螢幕左側時清除
- **運作方式**：
  - 定期在螢幕右側生成新的管道對
  - 每幀移動所有管道
  - 檢查小鳥是否通過管道，觸發計分
  - 移除已離開螢幕的管道以節省資源

#### 音效系統（Audio System）

- **功能**：播放遊戲音效提供聽覺回饋
- **處理事件**：
  - 拍翅（BIRD_FLAP）→ 播放翅膀拍動音效（wing.ogg）
  - 得分（INCREMENT_SCORE）→ 播放得分音效（point.ogg）
- **運作方式**：
  - 預先載入音效檔案至記憶體
  - 監聽遊戲事件，即時播放對應的音效
  - 支援獨立音量控制（每個音效可設定不同音量）

#### 背景系統（Background System）

- **功能**：管理背景元素的創建和移除
- **處理事件**：
  - 創建背景 → 顯示背景圖層
  - 移除背景 → 清除背景圖層
- **運作方式**：維護背景實體，委託渲染層負責視覺呈現

#### 地面系統（Ground System）

- **功能**：管理地面元素的創建和移除
- **處理事件**：
  - 創建地面 → 顯示地面圖層
  - 移除地面 → 清除地面圖層
- **運作方式**：維護地面實體，委託渲染層負責視覺呈現

#### 碰撞偵測系統（Collision System）

- **功能**：偵測遊戲中的碰撞並觸發遊戲結束邏輯
- **處理事件**：
  - 每幀更新 → 檢查小鳥與管道的碰撞
  - 每幀更新 → 檢查小鳥與地面的碰撞
  - 碰撞發生 → 觸發小鳥死亡和落地事件
- **運作方式**：
  - 使用 AABB（軸對齊邊界框）碰撞偵測演算法
  - **小鳥碰撞框**：28×20 像素（略小於 34×24 精靈圖，提升遊戲體驗）
    - 左右各縮小 3 像素，上下各縮小 2 像素
  - **管道碰撞框**：52 像素寬 × 可變高度（完整精靈圖尺寸）
  - **地面碰撞閾值**：螢幕高度 - (112 × 縮放比例)
  - 只有在小鳥存活時才檢查管道碰撞
  - 地面碰撞無論小鳥狀態都會檢查，允許死亡後的落地動畫完成

---

### 視覺呈現（Visual Rendering）

視覺呈現由「渲染器」負責，每個實體都有對應的渲染器將遊戲狀態轉換為螢幕上的圖像。

#### 小鳥渲染器（Bird Renderer）

- **呈現方式**：使用三幀精靈圖片製作拍翅動畫
  - 動畫速度：每幀持續約 133 毫秒（60fps 下 8 個遊戲幀）
  - 動畫會持續循環播放（下拍 → 中間 → 上拍 → 下拍...）
  - 小鳥死亡時動畫停止
- **視覺細節**：
  - 圖片中心作為旋轉軸心，確保旋轉自然
  - 位置和旋轉角度會即時同步實體狀態

#### 管道渲染器（Pipe Renderer）

- **呈現方式**：使用完整的管道精靈圖片（320 像素高）
  - 上方管道透過垂直翻轉（負縮放）實現
  - 超出螢幕的部分會被自然裁切
  - 超出遊戲區域的部分會被地面圖層覆蓋
- **視覺細節**：
  - 管道寬度：52 像素
  - 管道高度：320 像素（完整材質高度）

#### 分數渲染器（Score Renderer）

- **呈現方式**：使用數字精靈圖片（0-9）拼接成完整分數
  - 支援左對齊、中央對齊、右對齊三種方式
  - 數字間距可調整
  - 使用響應式縮放適應不同螢幕尺寸
- **視覺細節**：
  - 只在分數變化時重建數字精靈，提升效能
  - 舊的精靈會被正確銷毀，避免記憶體洩漏

#### 背景渲染器（Background Renderer）

- **呈現方式**：使用平鋪精靈（TilingSprite）自動填滿螢幕
- **視覺細節**：位於最底層，提供視覺背景

#### 地面渲染器（Ground Renderer）

- **呈現方式**：使用平鋪精靈橫向填滿螢幕底部
- **視覺細節**：
  - 位於中等的視覺層級（zIndex=50），在管道之上但在小鳥之下
  - 覆蓋超出遊戲區域的管道部分

#### 視覺層級順序（Visual Layer Order）

遊戲元素的渲染順序由高到低（從前到後）：

1. **分數（Score）** - 最上層（zIndex=200），永遠可見的 UI 元素
2. **小鳥（Bird）** - 第二層（zIndex=100），在地面之上確保玩家角色清晰可見
3. **地面（Ground）** - 第三層（zIndex=50），覆蓋管道底部形成自然的視覺效果
4. **管道（Pipes）** - 第四層（zIndex=10），互動障礙物
5. **背景（Background）** - 最底層（zIndex=0），裝飾性背景

這個層級設計確保：
- UI 元素永遠不會被遊戲物件遮擋
- 小鳥不會「沉入」地面
- 管道底部自然地被地面覆蓋，而不需要精確裁切
- 背景不會遮擋任何遊戲元素

---

## 5. 遊戲流程

完整的遊戲流程如下：

1. **遊戲啟動**：
   - 創建背景、地面、小鳥和分數實體
   - 初始化所有系統
   - 預載入音效和圖像資源

2. **玩家開始互動**：
   - 玩家點擊或按鍵讓小鳥開始飛行
   - 輸入系統接收指令並觸發拍翅事件
   - 物理系統施加向上速度，音效系統播放拍翅音效

3. **障礙物出現與移動**：
   - 障礙物系統定期生成新的管道對
   - 每幀更新時，所有管道向左移動
   - 玩家必須操控小鳥穿過縫隙

4. **計分或失敗**：
   - **成功通過管道**：
     - 障礙物系統透過邊緣比較偵測小鳥通過管道
     - 當小鳥的右側邊緣超過管道的右側邊緣時，標記管道為「已通過」
     - 觸發 INCREMENT_SCORE 事件，分數系統增加 1 分
     - 音效系統接收事件並播放得分音效（point.ogg）
     - 視覺即時更新顯示新分數
   - **碰撞失敗**：
     - 小鳥撞到管道或地面
     - 小鳥標記為死亡，動畫停止
     - 遊戲結束

5. **遊戲結束**：
   - 顯示最終分數
   - 玩家可以選擇重新開始

---

## 6. 設計文件索引

以下是按照架構層級分類的詳細設計文件，提供更深入的技術細節：

### 實體層（Entity Layer）

遊戲物件的狀態定義：

- [Bird（小鳥）](./design/entity/bird.md) - 玩家操控的角色
- [Pipe（管道）](./design/entity/pipe.md) - 障礙物
- [Score（分數）](./design/entity/score.md) - 分數顯示
- [Background（背景）](./design/entity/background.md) - 背景場景
- [Ground（地面）](./design/entity/ground.md) - 地面元素
- [Vector（向量）](./design/entity/vector.md) - 二維座標值物件

### 系統層（System Layer）

遊戲邏輯處理系統：

- [InputSystem（輸入系統）](./design/system/input_system.md) - 處理玩家輸入
- [PhysicsSystem（物理系統）](./design/system/physics_system.md) - 管理物理模擬
- [ScoreSystem（計分系統）](./design/system/score_system.md) - 追蹤分數
- [PipeSystem（障礙物系統）](./design/system/pipe_system.md) - 管理管道生成與移動
- [CollisionSystem（碰撞偵測系統）](./design/system/collision_system.md) - 偵測碰撞並觸發遊戲結束
- [AudioSystem（音效系統）](./design/system/audio_system.md) - 處理音效播放
- [BackgroundSystem（背景系統）](./design/system/background_system.md) - 管理背景元素
- [GroundSystem（地面系統）](./design/system/ground_system.md) - 管理地面元素

### 渲染層（Renderer Layer）

視覺呈現渲染器：

- [Bird（小鳥渲染器）](./design/renderer/bird.md) - 小鳥的視覺呈現
- [Pipe（管道渲染器）](./design/renderer/pipe.md) - 管道的視覺呈現
- [Score（分數渲染器）](./design/renderer/score.md) - 分數的視覺呈現
- [Background（背景渲染器）](./design/renderer/background.md) - 背景的視覺呈現
- [Ground（地面渲染器）](./design/renderer/ground.md) - 地面的視覺呈現

### 事件層（Event Layer）

遊戲事件定義（部分重要事件）：

- [CREATE_BIRD](./design/event/create_bird.md) - 創建小鳥
- [BIRD_FLAP](./design/event/bird_flap.md) - 小鳥拍翅
- [BIRD_COLLISION](./design/event/bird_collision.md) - 小鳥碰撞障礙物
- [BIRD_LAND](./design/event/bird_land.md) - 小鳥落地
- [KILL_BIRD](./design/event/kill_bird.md) - 小鳥死亡
- [CREATE_PIPE](./design/event/create_pipe.md) - 創建管道
- [CREATE_SCORE](./design/event/create_score.md) - 創建分數
- [INCREMENT_SCORE](./design/event/increment_score.md) - 增加分數
- [TICK](./design/event/tick.md) - 每幀更新
- [MOUSE_CLICK](./design/event/mouse_click.md) - 滑鼠點擊
- [KEY_DOWN](./design/event/key_down.md) - 鍵盤按下

### 基礎層（Foundation Layer）

工具與架構支援：

- [Layer（圖層順序管理）](./design/foundation/layer.md) - 渲染層級順序規範
- [Scale（縮放系統）](./design/foundation/scale.md) - 響應式縮放管理

---

## 7. 技術架構

完整的技術架構說明請參閱 [ARCHITECTURE.md](./ARCHITECTURE.md)。

本遊戲採用**事件驅動架構**，將遊戲邏輯與視覺呈現分離：

- **Engine（引擎）**：管理遊戲迴圈、事件佇列、狀態更新
- **Entity（實體）**：不可變的遊戲狀態定義
- **System（系統）**：純函數事件處理器，生成狀態更新指令
- **Adapter（適配器）**：連接純引擎與外部系統（如 PixiJS 渲染）
- **Renderer（渲染器）**：PixiJS 視覺渲染器，將狀態轉換為圖像

這種架構確保了：
- 遊戲邏輯與技術實作分離
- 狀態不可變性，易於測試與除錯
- 高內聚、低耦合的模組化設計
